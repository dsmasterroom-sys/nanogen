{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NanoGen 3 Pro</title>
    <link rel="icon" type="image/x-icon" href="{% static 'nanogen/favicon.ico' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Drawflow -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>

    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #eab308;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Drawflow Dark Theme Customization */
        .drawflow {
            background: #09090b !important;
            height: 100%;
            width: 100%;
        }

        /* Expand the Drawflow interaction layer to 40x the viewport for near-infinite panning */
        .drawflow .parent-drawflow {
            width: 4000vw !important;
            height: 4000vh !important;
            left: -1950vw !important;
            top: -1950vh !important;
            position: absolute !important;
        }

        .drawflow .drawflow-node {
            background: #18181b;
            border: 1px solid #3f3f46;
            color: #e4e4e7;
            border-radius: 12px;
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.7);
            padding: 0;
            width: 280px;
            will-change: top, left, transform;
            transform: translateZ(0);
        }

        .drawflow .drawflow-node.selected {
            border: 1px solid #eab308;
            background: #27272a;
        }

        .drawflow .drawflow-node.text_input,
        .drawflow .drawflow-node.text_input.selected {
            border: none;
            background: transparent;
            box-shadow: none;
            overflow: visible !important;
        }

        .drawflow .drawflow-node.text_input .drawflow_content_node {
            overflow: visible !important;
        }

        .drawflow .drawflow-node.text_input .box {
            padding: 0 !important;
        }

        .drawflow .drawflow-node.generator,
        .drawflow .drawflow-node.generator.selected {
            border: none;
            background: transparent;
            box-shadow: none;
            overflow: visible !important;
        }

        .drawflow .drawflow-node.generator .drawflow_content_node {
            overflow: visible !important;
        }

        .drawflow .drawflow-node .inputs .input {
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            background: rgba(24, 24, 27, 0.9);
            border: 1px solid #3f3f46;
            left: -6px;
            box-shadow: 0 0 0 1px rgba(9, 9, 11, 0.85);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-size: 10px;
            font-weight: 700;
            z-index: 12;
            pointer-events: auto;
        }

        .drawflow .drawflow-node .outputs .output {
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            background: rgba(24, 24, 27, 0.9);
            border: 1px solid #3f3f46;
            right: -6px;
            box-shadow: 0 0 0 1px rgba(9, 9, 11, 0.85);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-size: 10px;
            font-weight: 700;
            z-index: 12;
            pointer-events: auto;
        }

        .drawflow .drawflow-node .port-badge {
            min-width: 14px;
            height: 14px;
            padding: 0 2px;
            border-radius: 9999px;
            border: 1px solid rgba(161, 161, 170, 0.5);
            background: rgba(39, 39, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            color: #e4e4e7;
            font-size: 9px;
            font-weight: 700;
            pointer-events: none;
        }

        .drawflow .connection .main-path {
            stroke: #eab308;
            stroke-width: 3px;
        }

        .drawflow .connection .main-path:hover {
            stroke: #ca8a04;
        }

        .drawflow .drawflow-node .title-box {
            background: #27272a;
            padding: 8px 12px;
            border-bottom: 1px solid #3f3f46;
            border-radius: 12px 12px 0 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .drawflow .drawflow-node .title-box .node-title-icon {
            width: 16px;
            height: 16px;
            flex: 0 0 16px;
            min-width: 16px;
            min-height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .drawflow .drawflow-node .title-box .node-title-icon-wrap {
            width: 20px;
            height: 20px;
            flex: 0 0 20px;
            min-width: 20px;
            min-height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
        }

        .drawflow .drawflow-node .title-box .node-title-label {
            display: block;
            flex: 1 1 auto;
            min-width: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 0;
        }

        .drawflow .drawflow-node .box {
            padding: 16px;
        }

        .drawflow .drawflow-node .node-card {
            border: 1px solid #3f3f46;
            border-radius: 12px;
            background: #18181b;
            box-shadow: 0 4px 12px -4px rgba(0, 0, 0, 0.65);
            overflow: hidden;
            will-change: transform;
        }

        .drawflow .drawflow-node.selected .node-card {
            border-color: rgba(59, 130, 246, 0.92);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3), 0 12px 20px -10px rgba(0, 0, 0, 0.7);
        }

        .drawflow .drawflow-node .node-surface {
            border-color: #3f3f46;
            background: #18181b;
            border-radius: 14px;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }

        .drawflow .drawflow-node.selected .node-surface {
            border-color: rgba(59, 130, 246, 0.92);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.38);
        }

        .drawflow .drawflow-node .node-text-toolbar,
        .drawflow .drawflow-node .node-text-color-palette {
            display: none;
        }

        .drawflow .drawflow-node.selected .node-text-toolbar {
            display: flex;
        }

        .drawflow .drawflow-node.selected .node-text-color-palette.open {
            display: flex;
        }

        .drawflow .drawflow-node .node-input-text {
            border-color: #3f3f46;
        }

        .drawflow .drawflow-node.selected .node-input-text {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45);
        }

        .drawflow .drawflow-node.text_input .node-input-text {
            border-color: transparent !important;
            box-shadow: none !important;
        }

        .drawflow .drawflow-node.generator .node-generator-stage {
            border-color: transparent !important;
            box-shadow: none !important;
        }

        #drawflow-container.space-pan-active #drawflow,
        #drawflow-container.space-pan-active .drawflow {
            cursor: grab !important;
        }

        #drawflow-container.space-pan-active.space-pan-dragging #drawflow,
        #drawflow-container.space-pan-active.space-pan-dragging .drawflow {
            cursor: grabbing !important;
        }

        .drawflow .drawflow-node .node-resize-handle {
            position: absolute;
            right: -3px;
            bottom: -3px;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            background: rgba(24, 24, 27, 0.85);
            border: 1px solid rgba(161, 161, 170, 0.6);
            cursor: nwse-resize;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.15s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawflow .drawflow-node .node-resize-handle::before {
            content: '';
            width: 16px;
            height: 16px;
            border-right: 4px solid #e5e7eb;
            border-bottom: 4px solid #e5e7eb;
            border-radius: 0 0 12px 0;
            opacity: 0.95;
        }

        .drawflow .drawflow-node:hover .node-resize-handle,
        .drawflow .drawflow-node.selected .node-resize-handle {
            opacity: 0.95;
        }
    </style>
</head>

<body class="bg-[#09090b] text-zinc-200 overflow-hidden h-screen flex flex-col md:flex-row">

    <!-- Settings Sidebar -->
    <div
        class="hidden md:flex flex-col w-80 h-full border-r border-zinc-800 bg-zinc-900/50 backdrop-blur-sm relative z-20">
        <div class="p-6 border-b border-zinc-800 flex items-center justify-between">
            <h2 class="font-semibold text-white flex items-center gap-2">
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                Settings
            </h2>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8">
            <!-- Generation Settings -->
            <div id="generationSettings" class="space-y-8">
                <!-- INPUT -->
                <div class="space-y-3 pb-6 border-b border-zinc-800">
                    <div class="flex items-center justify-between">
                        <div
                            class="flex items-center gap-2 text-zinc-400 text-xs font-semibold uppercase tracking-wider">
                            <span>INPUT</span>
                        </div>
                        <button class="p-1 hover:bg-zinc-800 rounded text-zinc-500 hover:text-white transition-colors"
                            title="Add Input">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <textarea id="pgSourceInput" placeholder="Enter your prompt here..."
                            class="w-full h-40 bg-zinc-900/50 border border-zinc-800 rounded-lg p-3 text-xs text-zinc-300 resize-none outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 custom-scrollbar transition-colors"></textarea>
                    </div>
                </div>
            </div>

            <!-- Workflow Settings (Hidden by default) -->
            <div id="workflowSettings" class="hidden space-y-3 pb-6 border-b border-zinc-800">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-zinc-400 text-xs font-semibold uppercase tracking-wider">
                        <span>WORKFLOW</span>
                    </div>
                    <i data-lucide="git-merge" class="w-4 h-4 text-zinc-500"></i>
                </div>
                <select id="workflowSelect"
                    class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2.5 text-xs text-zinc-200 outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50">
                </select>
                <div class="grid grid-cols-2 gap-2">
                    <button id="newWorkflowBtn"
                        class="px-3 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-xs text-zinc-200 flex items-center justify-center gap-1.5">
                        <i data-lucide="plus" class="w-3 h-3"></i> New
                    </button>
                    <button id="loadWorkflowBtn"
                        class="px-3 py-2 rounded-lg bg-blue-700/70 hover:bg-blue-600 border border-blue-500/40 text-xs text-blue-100 flex items-center justify-center gap-1.5">
                        <i data-lucide="folder-open" class="w-3 h-3"></i> Load
                    </button>
                    <button id="saveWorkflowBtn"
                        class="px-3 py-2 rounded-lg bg-emerald-700/70 hover:bg-emerald-600 border border-emerald-500/40 text-xs text-emerald-100 flex items-center justify-center gap-1.5">
                        <i data-lucide="save" class="w-3 h-3"></i> Save
                    </button>
                    <button id="saveAsWorkflowBtn"
                        class="px-3 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-xs text-zinc-200 flex items-center justify-center gap-1.5">
                        <i data-lucide="copy-plus" class="w-3 h-3"></i> Save As
                    </button>
                    <button id="renameWorkflowBtn"
                        class="px-3 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-xs text-zinc-200 flex items-center justify-center gap-1.5">
                        <i data-lucide="pencil" class="w-3 h-3"></i> Rename
                    </button>
                    <button id="deleteWorkflowBtn"
                        class="px-3 py-2 rounded-lg bg-red-900/50 hover:bg-red-800/60 border border-red-500/40 text-xs text-red-200 flex items-center justify-center gap-1.5">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Delete
                    </button>
                </div>
            </div>

            <!-- Prompt Gen Settings (Hidden by default) -->
            <div id="promptGenSettings" class="hidden space-y-8">
                <!-- Type Toggle -->
                <div class="flex bg-zinc-900 border border-zinc-800 rounded-full p-1">
                    <button id="pgTypeImageBtn"
                        class="flex-1 py-1.5 text-xs font-bold rounded-full bg-zinc-700/50 text-white transition-all">IMAGE</button>
                    <button id="pgTypeVideoBtn"
                        class="flex-1 py-1.5 text-xs font-bold rounded-full text-zinc-500 hover:text-white transition-all">VIDEO</button>
                </div>

                <!-- CONCEPT -->
                <div class="space-y-3 pb-6 border-b border-zinc-800">
                    <div class="flex items-center justify-between">
                        <div
                            class="flex items-center gap-2 text-zinc-400 text-xs font-semibold uppercase tracking-wider">
                            <span>CONCEPT</span>
                        </div>
                        <button class="p-1 hover:bg-zinc-800 rounded text-zinc-500 hover:text-white transition-colors"
                            title="Add Concept">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <textarea id="pgConceptInput" placeholder="Enter main concept here..."
                        class="w-full h-24 bg-zinc-900/50 border border-zinc-800 rounded-lg p-3 text-xs text-zinc-300 resize-none outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 custom-scrollbar transition-colors"></textarea>
                </div>

                <!-- INPUT PRESETS -->
                <div class="space-y-3 pb-6 border-b border-zinc-800">
                    <div class="flex items-center justify-between">
                        <div
                            class="flex items-center gap-2 text-zinc-400 text-xs font-semibold uppercase tracking-wider">
                            <span>INPUT PRESETS</span>
                        </div>
                        <button id="addPgPresetBtn"
                            class="p-1 hover:bg-zinc-800 rounded text-zinc-500 hover:text-white transition-colors"
                            title="Add Input Preset">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <!-- PG Edit Form (Hidden by default) -->
                    <div id="pgPresetEditForm"
                        class="hidden bg-zinc-800/50 rounded-lg p-3 border border-zinc-700 space-y-3 animate-in fade-in zoom-in-95 duration-200">
                        <input type="hidden" id="editPgPresetId">
                        <input type="text" id="editPgPresetName" placeholder="Preset Name"
                            class="w-full bg-black/40 border border-zinc-700 rounded p-2 text-xs text-white focus:border-yellow-500 outline-none">
                        <textarea id="editPgPresetText" placeholder="Prompt Text..."
                            class="w-full bg-black/40 border border-zinc-700 rounded p-2 text-xs text-white h-24 resize-none focus:border-yellow-500 outline-none"></textarea>
                        <div class="flex justify-end gap-2">
                            <button id="cancelPgPresetEditBtn"
                                class="p-1.5 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                            <button id="savePgPresetBtn"
                                class="flex items-center gap-1 px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 text-black text-xs font-bold rounded">
                                <i data-lucide="save" class="w-3 h-3"></i> Save
                            </button>
                        </div>
                    </div>

                    <!-- PG Presets List -->
                    <div class="flex flex-col gap-2 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar"
                        id="pgInputPresetsList">
                        <!-- Items managed by JS -->
                    </div>
                </div>
            </div>

            <!-- Common Settings -->
            <div id="commonSidebarSettings" class="space-y-8">
                <!-- Prompt Presets -->
                <div class="space-y-3 pb-6 border-b border-zinc-800">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-zinc-400 text-xs font-semibold tracking-wider">
                            <span>Prompt Presets</span>
                            <span id="presetModeLabel" class="hidden">Gen</span>
                        </div>
                        <button id="addPresetBtn"
                            class="p-1 hover:bg-zinc-800 rounded text-zinc-500 hover:text-yellow-400 transition-colors"
                            title="Add New Preset">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- Edit Form (Hidden by default) -->
                    <div id="presetEditForm"
                        class="hidden bg-zinc-800/50 rounded-lg p-3 border border-zinc-700 space-y-3 animate-in fade-in zoom-in-95 duration-200">
                        <input type="hidden" id="editPresetId">
                        <input type="text" id="editPresetName" placeholder="Preset Name"
                            class="w-full bg-black/40 border border-zinc-700 rounded p-2 text-xs text-white focus:border-yellow-500 outline-none">
                        <textarea id="editPresetText" placeholder="Prompt Text..."
                            class="w-full bg-black/40 border border-zinc-700 rounded p-2 text-xs text-white h-24 resize-none focus:border-yellow-500 outline-none"></textarea>
                        <div class="flex justify-end gap-2">
                            <button id="cancelPresetEditBtn"
                                class="p-1.5 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                            <button id="savePresetBtn"
                                class="flex items-center gap-1 px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 text-black text-xs font-bold rounded">
                                <i data-lucide="save" class="w-3 h-3"></i> Save
                            </button>
                        </div>
                    </div>

                    <!-- Presets List -->
                    <div id="presetsList" class="space-y-2 max-h-[250px] overflow-y-auto pr-1 custom-scrollbar">
                        <!-- Items injected via JS -->
                    </div>
                </div>
            </div>

            <div id="generationMediaSection" class="space-y-8">
                <!-- MEDIA (Aspect Ratio & Resolution Combined) -->
                <div class="space-y-3 pb-6 border-b border-zinc-800">
                    <label class="text-xs font-medium text-zinc-500 uppercase tracking-wider">MEDIA</label>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Aspect Ratio Column -->
                        <div class="flex flex-col gap-2 relative">
                            <!-- Custom Dropdown Trigger -->
                            <button id="aspectRatioTrigger"
                                class="w-full flex items-center justify-between bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs rounded-lg p-3 outline-none hover:border-zinc-700 transition-colors">
                                <span id="aspectRatioSelectedText">16:9</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <!-- Custom Dropdown Menu -->
                            <div id="aspectRatioDropdown"
                                class="hidden absolute top-full left-0 w-full mt-1 flex-col gap-1 bg-zinc-900/95 border border-zinc-800 rounded-lg p-2 shadow-2xl z-50 backdrop-blur-md">
                                <button
                                    class="aspect-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-ratio="16:9">16:9</button>
                                <button
                                    class="aspect-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-ratio="9:16">9:16</button>
                                <button
                                    class="aspect-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-ratio="1:1">1:1</button>
                                <button
                                    class="aspect-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-ratio="3:4">3:4</button>
                                <button
                                    class="aspect-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-ratio="4:3">4:3</button>
                            </div>
                        </div>
                        <!-- Resolution Column -->
                        <div class="flex flex-col gap-2 relative">
                            <!-- Custom Dropdown Trigger -->
                            <button id="resolutionTrigger"
                                class="w-full flex items-center justify-between bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs rounded-lg p-3 outline-none hover:border-zinc-700 transition-colors">
                                <span id="resolutionSelectedText">1K</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <!-- Custom Dropdown Menu -->
                            <div id="resolutionDropdown"
                                class="hidden absolute top-full left-0 w-full mt-1 flex-col gap-1 bg-zinc-900/95 border border-zinc-800 rounded-lg p-2 shadow-2xl z-50 backdrop-blur-md">
                                <button
                                    class="resolution-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-resolution="1K">1K</button>
                                <button
                                    class="resolution-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-resolution="2K">2K</button>
                                <button
                                    class="resolution-btn w-full py-2 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-resolution="4K">4K</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ADVANCED VIDEO OPTIONS (Hidden by default, shown for Kling) -->
                <div id="advancedVideoOptions" class="space-y-3 pb-6 border-b border-zinc-800 hidden">
                    <label class="text-xs font-medium text-zinc-500 uppercase tracking-wider">KLING OPTIONS</label>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Mode Column -->
                        <div class="flex flex-col gap-2 relative">
                            <label class="text-[10px] text-zinc-500 uppercase">Mode</label>
                            <button id="klingModeTrigger"
                                class="w-full flex items-center justify-between bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs rounded-lg p-2.5 outline-none hover:border-zinc-700 transition-colors">
                                <span id="klingModeSelectedText">Standard</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div id="klingModeDropdown"
                                class="hidden absolute top-full left-0 w-full mt-1 flex-col gap-1 bg-zinc-900/95 border border-zinc-800 rounded-lg p-2 shadow-2xl z-50 backdrop-blur-md">
                                <button
                                    class="kling-mode-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-mode="std">Standard</button>
                                <button
                                    class="kling-mode-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-mode="pro">Pro (High Quality)</button>
                            </div>
                        </div>
                        <!-- Duration Column -->
                        <div class="flex flex-col gap-2 relative">
                            <label class="text-[10px] text-zinc-500 uppercase">Duration</label>
                            <button id="klingDurationTrigger"
                                class="w-full flex items-center justify-between bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs rounded-lg p-2.5 outline-none hover:border-zinc-700 transition-colors">
                                <span id="klingDurationSelectedText">5 Seconds</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div id="klingDurationDropdown"
                                class="hidden absolute top-full left-0 w-full mt-1 flex-col gap-1 bg-zinc-900/95 border border-zinc-800 rounded-lg p-2 shadow-2xl z-50 backdrop-blur-md">
                                <button
                                    class="kling-duration-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-duration="5">5 Seconds</button>
                                <button
                                    class="kling-duration-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all border border-transparent hover:border-zinc-700"
                                    data-duration="10">10 Seconds</button>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Movement -->
                    <div class="flex flex-col gap-2 relative mt-3">
                        <label class="text-[10px] text-zinc-500 uppercase">Camera Movement</label>
                        <button id="klingCameraTrigger"
                            class="w-full flex items-center justify-between bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs rounded-lg p-2.5 outline-none hover:border-zinc-700 transition-colors">
                            <span id="klingCameraSelectedText">None</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                        <div id="klingCameraDropdown"
                            class="hidden absolute top-full left-0 w-full mt-1 flex-col gap-1 bg-zinc-900/95 border border-zinc-800 rounded-lg p-2 shadow-2xl z-50 backdrop-blur-md">
                            <button
                                class="kling-camera-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all"
                                data-camera="">None</button>
                            <button
                                class="kling-camera-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all"
                                data-camera="left">Pan Left</button>
                            <button
                                class="kling-camera-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all"
                                data-camera="right">Pan Right</button>
                            <button
                                class="kling-camera-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all"
                                data-camera="up">Tilt Up</button>
                            <button
                                class="kling-camera-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all"
                                data-camera="down">Tilt Down</button>
                            <button
                                class="kling-camera-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all"
                                data-camera="forward">Zoom In</button>
                            <button
                                class="kling-camera-btn w-full py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all"
                                data-camera="backward">Zoom Out</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grounding Toggle -->
            <div class="space-y-3">
                <label class="text-xs font-medium text-zinc-500 uppercase tracking-wider block">Grounding</label>
                <div class="flex items-center justify-between p-3 rounded-xl bg-zinc-900/50 border border-zinc-800">
                    <span class="text-sm">Use Google Search</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="useGrounding" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500">
                        </div>
                    </label>
                </div>
            </div>

            <!-- Brush Tools Toggle -->
            <div class="space-y-3" id="brushToolsSection">
                <label class="text-xs font-medium text-zinc-500 uppercase tracking-wider block">Editor Tools</label>
                <div class="flex items-center justify-between p-3 rounded-xl bg-zinc-900/50 border border-zinc-800">
                    <span class="text-sm">Enable Brush</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="showBrushTools" class="sr-only peer" checked>
                        <div
                            class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500">
                        </div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full relative">

        <!-- Top Bar -->
        <header
            class="h-16 border-b border-zinc-800 flex items-center justify-between px-6 bg-zinc-900/50 backdrop-blur-sm z-10">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="sparkles" class="w-4 h-4 text-black"></i>
                    </div>
                    <h1 class="font-bold text-lg tracking-tight text-white hidden md:block">NanoGen <span
                            class="text-yellow-500">3 Pro</span></h1>
                </div>

                <div class="flex p-1 bg-zinc-900 border border-zinc-800 rounded-lg">
                    <button
                        class="mode-btn px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 text-zinc-500 hover:text-zinc-300"
                        data-mode="generation">
                        <i data-lucide="image" class="w-3 h-3"></i> Generation
                    </button>
                    <button
                        class="mode-btn px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 text-zinc-500 hover:text-zinc-300"
                        data-mode="composition">
                        <i data-lucide="layers" class="w-3 h-3"></i> Composition
                    </button>
                    <button
                        class="mode-btn px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 text-zinc-500 hover:text-zinc-300"
                        data-mode="identity_swap">
                        <i data-lucide="user-round-cog" class="w-3 h-3"></i> ID Swap
                    </button>
                    <button
                        class="mode-btn px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 text-zinc-500 hover:text-zinc-300"
                        data-mode="library">
                        <i data-lucide="grid" class="w-3 h-3"></i> Library
                    </button>
                    <button
                        class="mode-btn px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 text-zinc-500 hover:text-zinc-300"
                        data-mode="source_library">
                        <i data-lucide="folder-open" class="w-3 h-3"></i> Source Lib
                    </button>
                    <button
                        class="mode-btn px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 text-zinc-500 hover:text-zinc-300"
                        data-mode="prompt_gen">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> Prompt Gen
                    </button>
                    <button
                        class="mode-btn px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-2 text-yellow-500 hover:text-yellow-400 border border-yellow-500/30 bg-yellow-500/10"
                        data-mode="workflow">
                        <i data-lucide="git-merge" class="w-3 h-3"></i> Workflow Studio
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div
                    class="flex items-center gap-2 text-xs text-zinc-500 bg-zinc-900 px-3 py-1.5 rounded-full border border-zinc-800">
                    <div id="statusIndicator" class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>
        </header>

        <!-- Canvas -->
        <main
            class="flex-1 overflow-hidden relative flex flex-col items-center justify-center p-4 md:p-6 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-zinc-900 via-[#09090b] to-black">

            <!-- Source Select Modal -->
            <div id="sourceSelectModal"
                class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
                <div
                    class="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-4xl max-h-[85vh] flex flex-col shadow-2xl">
                    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
                        <h3 class="text-[15px] font-semibold text-white">Select Image</h3>
                        <button id="closeSourceModalBtn" class="text-zinc-500 hover:text-white">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="p-4 flex gap-4 justify-center border-b border-zinc-800 bg-zinc-950/30">
                        <button id="uploadLocalBtn"
                            class="px-5 py-2.5 bg-yellow-500 text-black hover:bg-yellow-400 font-bold rounded-lg text-sm flex items-center gap-2 shadow-sm transition-transform hover:-translate-y-0.5 active:translate-y-0">
                            <i data-lucide="upload" class="w-4 h-4"></i> Upload Local File
                        </button>
                    </div>

                    <div class="flex-1 flex flex-row overflow-hidden">
                        <!-- Left Pane: Generated Library -->
                        <div class="flex-1 flex flex-col border-r border-zinc-800">
                            <div class="p-3 bg-zinc-900 border-b border-zinc-800 shrink-0 sticky top-0 z-10">
                                <h4 class="text-xs font-semibold text-zinc-400 text-center uppercase tracking-wider">
                                    Generated Images</h4>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                <div id="libraryModalGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                    <!-- Items injected via JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Pane: Source Library -->
                        <div class="flex-1 flex flex-col">
                            <div class="p-3 bg-zinc-900 border-b border-zinc-800 shrink-0 sticky top-0 z-10">
                                <h4 class="text-xs font-semibold text-zinc-400 text-center uppercase tracking-wider">
                                    Source Uploads</h4>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                <div id="sourceModalGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                    <!-- Items injected via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mask Editor Modal -->
            <div id="maskEditorModal"
                class="hidden fixed inset-0 z-[70] bg-black/95 flex flex-col items-center justify-center p-4">

                <!-- Toolbar -->
                <div
                    class="fixed top-4 left-1/2 -translate-x-1/2 bg-zinc-900 border border-zinc-700 rounded-full px-6 py-3 flex items-center gap-6 shadow-2xl z-[80]">
                    <div class="flex items-center gap-3">
                        <i data-lucide="brush" class="w-4 h-4 text-yellow-500"></i>
                        <input type="range" id="brushSize" min="5" max="100" value="30" class="w-32 accent-yellow-500">
                    </div>
                    <div class="h-6 w-px bg-zinc-700"></div>
                    <button id="clearMaskBtn"
                        class="text-zinc-400 hover:text-white text-xs font-medium flex items-center gap-2">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Clear
                    </button>
                    <div class="h-6 w-px bg-zinc-700"></div>
                    <button id="saveMaskBtn"
                        class="text-black bg-yellow-500 hover:bg-yellow-400 font-bold text-xs px-4 py-1.5 rounded-full flex items-center gap-2 transition-all">
                        <i data-lucide="check" class="w-4 h-4"></i> Done
                    </button>
                    <button id="closeMaskEditorBtn" class="ml-2 text-zinc-500 hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Canvas Container -->
                <div id="maskCanvasContainer"
                    class="relative max-w-full max-h-[85vh] border border-zinc-800 rounded-lg overflow-hidden cursor-crosshair">
                    <img id="maskTargetImage" src="" class="max-w-full max-h-[85vh] object-contain pointer-events-none">
                    <canvas id="maskCanvas" class="absolute inset-0 w-full h-full trigger-gpu"></canvas>
                </div>

                <div class="mt-4 text-zinc-500 text-xs text-center animate-pulse">
                    Paint over the area you want to edit (Inpaint).
                </div>
            </div>

            <!-- Error Banner -->
            <div id="errorBanner"
                class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-red-500/10 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg flex items-center gap-2 z-[100] max-w-lg w-full shadow-xl backdrop-blur-md">
                <i data-lucide="alert-circle" class="w-5 h-5 shrink-0"></i>
                <p class="text-sm" id="errorMessage"></p>
                <button onclick="document.getElementById('errorBanner').classList.add('hidden')"
                    class="ml-auto hover:text-white">&times;</button>
            </div>

            <!-- Views -->
            <div id="viewContainer" class="w-full h-full flex items-center justify-center">
                <!-- Content injected via JS -->
            </div>

        </main>

        <!-- Prompt Bar -->
        <div id="bottomPromptBar" class="p-4 md:p-6 bg-zinc-950/90 backdrop-blur-xl border-t border-zinc-800 z-20">
            <div class="max-w-6xl mx-auto relative flex gap-4 items-stretch">

                <!-- Attachment Button (Generation Mode) -->
                <div id="attachmentArea" class="hidden items-end pb-1">
                    <input type="file" id="referenceInput" class="hidden" accept="image/*">
                    <button id="attachBtn"
                        class="h-12 w-12 rounded-xl flex items-center justify-center border border-zinc-700 bg-zinc-800/50 text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 transition-all shrink-0">
                        <i data-lucide="paperclip" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="relative flex-1 flex flex-col">
                    <!-- Reference Image Preview -->
                    <div id="referencePreview"
                        class="hidden absolute bottom-full left-0 mb-3 p-2 bg-zinc-800 rounded-xl border border-zinc-700 flex items-center gap-3 shadow-lg z-30">
                        <div class="relative w-12 h-12 rounded-lg overflow-hidden bg-black/50">
                            <img id="referencePreviewImg" src="" alt="Reference" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs font-medium text-zinc-300">Image Attached</span>
                            <button id="removeReferenceBtn"
                                class="text-[10px] text-red-400 hover:underline text-left">Remove</button>
                        </div>
                    </div>

                    <textarea id="promptInput" placeholder="Describe your image..."
                        class="w-full bg-zinc-900/50 border border-zinc-700 rounded-xl px-4 py-4 pr-4 pb-8 text-zinc-200 placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-yellow-500/50 focus:border-yellow-500/50 resize-none h-28 custom-scrollbar shadow-inner text-sm leading-relaxed transition-colors"></textarea>

                    <div
                        class="absolute right-4 bottom-3 text-[11px] font-medium text-zinc-500 bg-zinc-900/80 px-2 py-0.5 rounded pointer-events-none">
                        <span id="promptLength">0</span>/2000
                    </div>
                </div>

                <div class="flex flex-col justify-end pb-1">
                    <button id="generateBtn"
                        class="h-14 px-8 rounded-xl font-bold flex items-center gap-2 transition-all shrink-0 bg-yellow-500 text-black shadow-[0_0_20px_rgba(234,179,8,0.15)] hover:shadow-[0_0_25px_rgba(234,179,8,0.3)] hover:bg-yellow-400 hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="hidden md:inline text-sm">Generate</span>
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'nanogen/js/app.js' %}?v=52"></script>
    <script>
        lucide.createIcons();
    </script>
</body>

</html>